"use strict";exports.id=7750,exports.ids=[7750],exports.modules={27130:(e,t,r)=>{r.d(t,{T:()=>n});let n="5.0.0"},37750:(e,t,r)=>{r.d(t,{ApolloServerPluginUsageReporting:()=>I});var n=r(91129),s=r(69683),a=r(73047),o=r(16671),i=r(21820),l=r(74075),u=r(32522),c=r(12874),h=r(24813);function p(e,t,r){let n=r?new g:y;if(e.root&&d(e.root,n,t)||e.queryPlan&&function e(t,r,n){return!!t&&(t.fetch?.trace?.root&&t.fetch.serviceName?d(t.fetch.trace.root,r.child(`service:${t.fetch.serviceName}`),n):t.flatten?.node?e(t.flatten.node,r,n):t.parallel?.nodes?t.parallel.nodes.some(t=>e(t,r,n)):!!t.sequence?.nodes&&t.sequence.nodes.some(t=>e(t,r,n)))}(e.queryPlan,n,t))return}function d(e,t,r){return!!r(e,t)||(e.child?.some(e=>{let n=e.responseName?t.child(e.responseName):t;return d(e,n,r)})??!1)}let y={toArray(){throw Error("not collecting paths!")},child(){return this}};class g{toArray(){return[]}child(e){return new f(e,this)}}class f{responseName;prev;constructor(e,t){this.responseName=e,this.prev=t}toArray(){let e=[],t=this;for(;t instanceof f;)e.push(t.responseName),t=t.prev;return e.reverse()}child(e){return new f(e,this)}}class m{buckets;static BUCKET_COUNT=384;static EXPONENT_LOG=Math.log(1.1);toArray(){let e=0,t=[];for(let r of this.buckets)0===r?e++:(1===e?t.push(0):0!==e&&t.push(-e),t.push(Math.floor(r)),e=0);return t}static durationToBucket(e){let t=Math.ceil(Math.log(e/1e3)/m.EXPONENT_LOG);return t<=0||Number.isNaN(t)?0:t>=m.BUCKET_COUNT?m.BUCKET_COUNT-1:t}incrementDuration(e,t=1){return this.incrementBucket(m.durationToBucket(e),t),this}incrementBucket(e,t=1){if(e>=m.BUCKET_COUNT)throw Error("Bucket is out of bounds of the buckets array");if(e>=this.buckets.length){let t=this.buckets.length;this.buckets.length=e+1,this.buckets.fill(0,t)}this.buckets[e]+=t}combine(e){for(let t=0;t<e.buckets.length;t++)this.incrementBucket(t,e.buckets[t])}constructor(e){let t=e?.initSize||74,r=e?.buckets,n=Math.max(r?.length||0,t);this.buckets=Array(n).fill(0),r&&r.forEach((e,t)=>this.buckets[t]=e)}}class b{bytes=0}class C{header;tracesPreAggregated=!1;constructor(e){this.header=e}tracesPerQuery=Object.create(null);endTime=null;operationCount=0;sizeEstimator=new b;ensureCountsAreIntegers(){for(let e of Object.values(this.tracesPerQuery))e.ensureCountsAreIntegers()}addTrace({statsReportKey:e,trace:t,asTrace:r,referencedFieldsByType:s,maxTraceBytes:a=0xa00000,nonFtv1ErrorPaths:o}){let i=this.getTracesAndStats({statsReportKey:e,referencedFieldsByType:s});if(r){let e=n.Cn.encode(t).finish();!isNaN(a)&&e.length>a?i.statsWithContext.addTrace(t,this.sizeEstimator,o):(i.trace.push(e),this.sizeEstimator.bytes+=2+e.length)}else i.statsWithContext.addTrace(t,this.sizeEstimator,o)}getTracesAndStats({statsReportKey:e,referencedFieldsByType:t}){let r=this.tracesPerQuery[e];if(r)return r;for(let[r,n]of(this.sizeEstimator.bytes+=A(e),Object.entries(t)))for(let e of(this.sizeEstimator.bytes+=4,n.isInterface&&(this.sizeEstimator.bytes+=2),this.sizeEstimator.bytes+=A(r),n.fieldNames))this.sizeEstimator.bytes+=A(e);return this.tracesPerQuery[e]=new T(t)}}class T{referencedFieldsByType;constructor(e){this.referencedFieldsByType=e}trace=[];statsWithContext=new S;internalTracesContributingToStats=[];ensureCountsAreIntegers(){this.statsWithContext.ensureCountsAreIntegers()}}class S{map=Object.create(null);toArray(){return Object.values(this.map)}ensureCountsAreIntegers(){for(let e of Object.values(this.map))e.ensureCountsAreIntegers()}addTrace(e,t,r){this.getContextualizedStats(e,t).addTrace(e,t,r)}getContextualizedStats(e,t){let r={clientName:e.clientName,clientVersion:e.clientVersion},n=JSON.stringify(r),s=this.map[n];if(s)return s;t.bytes+=20+A(e.clientName)+A(e.clientVersion);let a=new v(r);return this.map[n]=a,a}}class v{context;queryLatencyStats=new w;perTypeStat=Object.create(null);constructor(e){this.context=e}ensureCountsAreIntegers(){for(let e of Object.values(this.perTypeStat))e.ensureCountsAreIntegers()}addTrace(e,t,r=[]){let{fieldExecutionWeight:s}=e;if(!s&&this.queryLatencyStats.requestsWithoutFieldInstrumentation++,this.queryLatencyStats.requestCount++,e.fullQueryCacheHit?(this.queryLatencyStats.cacheLatencyCount.incrementDuration(e.durationNs),this.queryLatencyStats.cacheHits++):this.queryLatencyStats.latencyCount.incrementDuration(e.durationNs),!e.fullQueryCacheHit&&e.cachePolicy?.maxAgeNs!=null)switch(e.cachePolicy.scope){case n.Cn.CachePolicy.Scope.PRIVATE:this.queryLatencyStats.privateCacheTtlCount.incrementDuration(e.cachePolicy.maxAgeNs);break;case n.Cn.CachePolicy.Scope.PUBLIC:this.queryLatencyStats.publicCacheTtlCount.incrementDuration(e.cachePolicy.maxAgeNs)}e.persistedQueryHit&&this.queryLatencyStats.persistedQueryHits++,e.persistedQueryRegister&&this.queryLatencyStats.persistedQueryMisses++,e.forbiddenOperation&&this.queryLatencyStats.forbiddenOperationCount++,e.registeredOperation&&this.queryLatencyStats.registeredOperationCount++;let a=!1,o=new Set;for(let{subgraph:n,path:i}of(p(e,(e,r)=>{if(e.error?.length){a=!0;let n=this.queryLatencyStats.rootErrorStats;r.toArray().forEach(e=>{n=n.getChild(e,t)}),o.add(n),n.errorsCount+=e.error.length}if(s){let r=e.originalFieldName||e.responseName;if(e.parentType&&r&&e.type&&null!=e.endTime&&null!=e.startTime&&e.endTime>=e.startTime){let n=this.getTypeStat(e.parentType,t).getFieldStat(r,e.type,t);n.errorsCount+=e.error?.length??0,n.observedExecutionCount++,n.estimatedExecutionCount+=s,n.requestsWithErrorsCount+=+((e.error?.length??0)>0),n.latencyCount.incrementDuration(e.endTime-e.startTime,s)}}return!1},!0),r))if(a=!0,i){let e=this.queryLatencyStats.rootErrorStats.getChild(`service:${n}`,t);i.forEach(r=>{"string"==typeof r&&(e=e.getChild(r,t))}),o.add(e),e.errorsCount+=1}for(let e of o)e.requestsWithErrorsCount+=1;a&&this.queryLatencyStats.requestsWithErrorsCount++}getTypeStat(e,t){let r=this.perTypeStat[e];if(r)return r;t.bytes+=A(e);let n=new N;return this.perTypeStat[e]=n,n}}class w{latencyCount=new m;requestCount=0;requestsWithoutFieldInstrumentation=0;cacheHits=0;persistedQueryHits=0;persistedQueryMisses=0;cacheLatencyCount=new m;rootErrorStats=new E;requestsWithErrorsCount=0;publicCacheTtlCount=new m;privateCacheTtlCount=new m;registeredOperationCount=0;forbiddenOperationCount=0}class E{children=Object.create(null);errorsCount=0;requestsWithErrorsCount=0;getChild(e,t){let r=this.children[e];if(r)return r;let n=new E;return this.children[e]=n,t.bytes+=A(e)+4,n}}class N{perFieldStat=Object.create(null);getFieldStat(e,t,r){let n=this.perFieldStat[e];if(n)return n;r.bytes+=A(e)+A(t)+10;let s=new P(t);return this.perFieldStat[e]=s,s}ensureCountsAreIntegers(){for(let e of Object.values(this.perFieldStat))e.ensureCountsAreIntegers()}}class P{returnType;errorsCount=0;observedExecutionCount=0;estimatedExecutionCount=0;requestsWithErrorsCount=0;latencyCount=new m;constructor(e){this.returnType=e}ensureCountsAreIntegers(){this.estimatedExecutionCount=Math.floor(this.estimatedExecutionCount)}}function A(e){return 2+Buffer.byteLength(e)}var O=r(27130),q=r(63041),x=r(7639);let R={hostname:i.hostname(),agentVersion:`@apollo/server@${O.T}`,runtimeVersion:`node ${process.version}`,uname:`${i.platform()}, ${i.type()}, ${i.release()}, ${i.arch()})`};function I(e=Object.create(null)){let t=e.fieldLevelInstrumentation,r="number"==typeof t?async()=>Math.random()<t?1/t:0:t||(async()=>!0),i=null;return(0,u.R)({__internal_plugin_id__:"UsageReporting",__is_disabled_plugin__:!1,requestDidStart:async e=>i?i(e):{},async serverWillStart({logger:t,apollo:u,startedInBackground:d,schema:y}){let g,f;let b=e.logger??t,{key:T,graphRef:S}=u;if(!(T&&S))throw Error("You've enabled usage reporting via ApolloServerPluginUsageReporting, but you also need to provide your Apollo API key and graph ref, via the APOLLO_KEY/APOLLO_GRAPH_REF environment variables or via `new ApolloServer({apollo: {key, graphRef})`.");if((0,x.e)(y)){if(e.__onlyIfSchemaIsNotSubgraph)return b.warn("You have specified an Apollo API key and graph ref but this server appears to be a subgraph. Typically usage reports are sent to Apollo by your Router or Gateway, not directly from your subgraph; usage reporting is disabled. To enable usage reporting anyway, explicitly install `ApolloServerPluginUsageReporting`. To disable this warning, install `ApolloServerPluginUsageReportingDisabled`."),{};b.warn("You have installed `ApolloServerPluginUsageReporting` but this server appears to be a subgraph. Typically usage reports are sent to Apollo by your Router or Gateway, not directly from your subgraph. If this was unintentional, remove `ApolloServerPluginUsageReporting` from your server's `plugins` array.")}b.info(`Apollo usage reporting starting! See your graph at https://studio.apollographql.com/graph/${encodeURI(S)}/`);let v=e.sendReportsImmediately??d,w=null,E=new Map,N=e=>{let t=E.get(e);if(t)return t;let r=new C(new n.Y6({...R,executableSchemaId:e,graphRef:S}));return E.set(e,r),r},P=e=>{let t=E.get(e);return t?(E.delete(e),t):null},A=e.overrideReportedSchema?(0,q.u)(e.overrideReportedSchema):void 0;v||(f=setInterval(()=>U(),e.reportIntervalMs||1e4));let O=e.sendTraces??!0,I=e.experimental_sendOperationAsTrace??function(){let e=new h.q({maxSize:1048576,sizeCalculation:(e,t)=>t&&Buffer.byteLength(t)||0});return(t,r)=>{let n,s=t.endTime?.seconds;if(null==s)throw Error("programming error: endTime not set on trace");let a=(n=!1,p(t,function(e){return(e.error?.length??0)>0&&(n=!0),n},!1),n),o=JSON.stringify([r,m.durationToBucket(t.durationNs),Math.floor(s/60),a?Math.floor(s/5):""]);return!e.get(o)&&(e.set(o,!0),!0)}}(),k=!1;function L(e){if(g?.executableSchema===e)return g.executableSchemaId;let t=(0,q.u)((0,o.rK)(e));return g={executableSchema:e,executableSchemaId:t},t}async function U(){await Promise.all([...E.keys()].map(e=>_(e)))}async function _(t){return B(t).catch(t=>{e.reportErrorFunction?e.reportErrorFunction(t):b.error(t.message)})}let B=async t=>{let r=P(t);if(!r||0===Object.keys(r.tracesPerQuery).length&&0===r.operationCount)return;r.endTime=(0,c.Q)(new Date),r.ensureCountsAreIntegers();let s=n.pl.verify(r);if(s)throw Error(`Error verifying report: ${s}`);let o=n.pl.encode(r).finish();if(r=null,e.debugPrintReports){let e=n.pl.decode(o);b.info(`Apollo usage report: ${JSON.stringify(e.toJSON())}`)}let i=await new Promise((e,t)=>{(0,l.gzip)(o,(r,n)=>{r?t(r):e(n)})});o=null;let u=e.fetcher??fetch,h=await a(async()=>{let t=await u((e.endpointUrl||"https://usage-reporting.api.apollographql.com")+"/api/ingress/traces",{method:"POST",headers:{"user-agent":"ApolloServerPluginUsageReporting","x-api-key":T,"content-encoding":"gzip",accept:"application/json"},body:i,signal:AbortSignal.timeout(e.requestTimeoutMs??3e4)});if(!(t.status>=500)||!(t.status<600))return t;throw Error(`HTTP status ${t.status}, ${await t.text()||"(no body)"}`)},{retries:(e.maxAttempts||5)-1,minTimeout:e.minimumRetryDelayMs||100,factor:2}).catch(e=>{throw Error(`Error sending report to Apollo servers: ${e.message}`)});if(h.status<200||h.status>=300)throw Error(`Error sending report to Apollo servers: HTTP status ${h.status}, ${await h.text()||"(no body)"}`);if(O&&200===h.status&&h.headers.get("content-type")?.match(/^\s*application\/json\s*(?:;|$)/i)){let e;let t=await h.text();try{e=JSON.parse(t)}catch(e){throw Error(`Error parsing response from Apollo servers: ${e}`)}!0===e.tracesIgnored&&(b.debug("This graph's organization does not have access to traces; sending all subsequent operations as stats."),O=!1)}e.debugPrintReports&&b.info(`Apollo usage report: status ${h.status}`)};return i=({metrics:t,schema:a,request:{http:o,variables:i}})=>{let l=new c.B({maskedBy:"ApolloServerPluginUsageReporting",sendErrors:e.sendErrors});l.startTiming(),t.startHrTime=l.startHrTime;let u=!1,p=!1,d=null;async function y(t){if(null===d){if("function"!=typeof e.includeRequest){d=!0;return}"boolean"!=typeof(d=await e.includeRequest(t))&&(b.warn("The 'includeRequest' async predicate function must return a boolean value."),d=!0)}}o&&(l.trace.http=new n.Cn.HTTP({method:n.Cn.HTTP.Method[o.method]||n.Cn.HTTP.Method.UNKNOWN}),e.sendHeaders&&function(e,t,r){if(r&&(!("none"in r)||!r.none)&&(!("all"in r)||r.all)){for(let[s,a]of t)if(!("exceptNames"in r&&r.exceptNames.some(e=>e.toLowerCase()===s))&&(!("onlyNames"in r)||r.onlyNames.some(e=>e.toLowerCase()===s)))switch(s){case"authorization":case"cookie":case"set-cookie":break;default:e.requestHeaders[s]=new n.Cn.HTTP.Values({value:[a]})}}}(l.trace.http,o.headers,e.sendHeaders));let g=!1;return{async didResolveSource(r){g=!0,t.persistedQueryHit&&(l.trace.persistedQueryHit=!0),t.persistedQueryRegister&&(l.trace.persistedQueryRegister=!0),i&&(l.trace.details=function(e,t,r){let s=new n.Cn.Details,a=(()=>{if(!t||!("transform"in t))return e;{let n=Object.keys(e);try{let s=t.transform({variables:e,operationString:r});return function(e,t){let r=Object.create(null);return e.forEach(e=>{r[e]=t[e]}),r}(n,s)}catch(e){return function(e){let t=Object.create(null);return e.forEach(e=>{t[e]="[PREDICATE_FUNCTION_ERROR]"}),t}(n)}}})();return Object.keys(a).forEach(e=>{if(!t||"none"in t&&t.none||"all"in t&&!t.all||"exceptNames"in t&&t.exceptNames.includes(e)||"onlyNames"in t&&!t.onlyNames.includes(e))s.variablesJson[e]="";else try{s.variablesJson[e]=void 0===a[e]?"":JSON.stringify(a[e])}catch(t){s.variablesJson[e]=JSON.stringify("[Unable to convert value to JSON]")}}),s}(i,e.sendVariableValues,r.source));let s=(e.generateClientInfo||function({request:e}){let t="apollographql-client-name",r="apollographql-client-version";return e.http?.headers?.get(t)||e.http?.headers?.get(r)?{clientName:e.http?.headers?.get(t),clientVersion:e.http?.headers?.get(r)}:e.extensions?.clientInfo?e.extensions.clientInfo:{}})(r);if(s){let{clientName:e,clientVersion:t}=s;l.trace.clientVersion=t||"",l.trace.clientName=e||""}},validationDidStart:async()=>async e=>{u=!!e&&0!==e.length},async didResolveOperation(e){if(p=void 0===e.operation,await y(e),d&&!p&&void 0===t.captureTraces){let n=await r(e);l.trace.fieldExecutionWeight="number"==typeof n?n:+!!n,t.captureTraces=!!l.trace.fieldExecutionWeight}},async executionDidStart(){if(t.captureTraces)return{willResolveField:({info:e})=>l.willResolveField(e)}},async didEncounterSubsequentErrors(e,t){l.didEncounterErrors(t)},async willSendSubsequentPayload(e,t){t.hasNext||await f(e)},async willSendResponse(e){g&&(e.errors&&l.didEncounterErrors(e.errors),"single"===e.response.body.kind&&await f(e))}};async function f(r){let o=!!r.operation;await y(r),l.stopTiming();let i=A??L(a);if(!1===d){o&&N(i).operationCount++;return}l.trace.fullQueryCacheHit=!!t.responseCacheHit,l.trace.forbiddenOperation=!!t.forbiddenOperation,l.trace.registeredOperation=!!t.registeredOperation;let c=r.overallCachePolicy.policyIfCacheable();async function g(){let i,c;if(k)return;await new Promise(e=>setImmediate(e));let d=A??L(a),{trace:y}=l;r.document?u?c=`## GraphQLValidationFailure
`:p&&(c=`## GraphQLUnknownOperationName
`):c=`## GraphQLParseFailure
`;let g=void 0===c;if(c)e.sendUnexecutableOperationDocuments&&(y.unexecutedOperationBody=r.source,y.unexecutedOperationName=r.request.operationName||""),i=Object.create(null);else{let t=function(){var t,n;if(!r.document)throw Error("No document?");let o=(t=r.queryHash,n=r.operationName||"",`${t}${n&&":"+n}`);w&&w.forSchema===a||(w={forSchema:a,cache:function({logger:e}){let t;let r=0;return new h.q({sizeCalculation:e=>Buffer.byteLength(JSON.stringify(e),"utf8"),maxSize:0xa00000,dispose(){r++,(!t||new Date().getTime()-t.getTime()>6e4)&&(t=new Date,e.warn(`This server is processing a high number of unique operations.  A total of ${r} records have been ejected from the ApolloServerPluginUsageReporting signature cache in the past interval.  If you see this warning frequently, please open an issue on the Apollo Server repository.`),r=0)}})}({logger:b})});let i=w.cache.get(o);if(i)return i;let l={signature:(e.calculateSignature||s.usageReportingSignature)(r.document,r.operationName||""),referencedFieldsByType:(0,s.calculateReferencedFieldsByType)({document:r.document,schema:a,resolvedOperationName:r.operationName??null})};return w.cache.set(o,l),l}();c=`# ${r.operationName||"-"}
${t.signature}`,i=t.referencedFieldsByType}let f=n.Cn.verify(y);if(f)throw Error(`Error encoding trace: ${f}`);o&&N(d).operationCount++,N(d).addTrace({statsReportKey:c,trace:y,asTrace:O&&(!g||!!t.captureTraces)&&!t.nonFtv1ErrorPaths?.length&&I(y,c),referencedFieldsByType:i,nonFtv1ErrorPaths:t.nonFtv1ErrorPaths??[]}),(v||N(d).sizeEstimator.bytes>=(e.maxUncompressedReportSize||4194304))&&await _(d)}c&&(l.trace.cachePolicy=new n.Cn.CachePolicy({scope:"PRIVATE"===c.scope?n.Cn.CachePolicy.Scope.PRIVATE:"PUBLIC"===c.scope?n.Cn.CachePolicy.Scope.PUBLIC:n.Cn.CachePolicy.Scope.UNKNOWN,maxAgeNs:1e9*c.maxAge})),t.queryPlanTrace&&(l.trace.queryPlan=t.queryPlanTrace),g().catch(b.error.bind(b))}},{async serverWillStop(){f&&(clearInterval(f),f=void 0),k=!0,await U()}}}})}}};